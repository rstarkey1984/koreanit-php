
# ⚙️ 윈도우에서 WSL를 이용해 Ubuntu + Nginx + PHP 개발환경 설치하기

- 아래 단계를 진행하기 전 VSCode가 설치되어 있지 않으면 먼저 VSCode를 설치하세요.
   
   - VSCode 설치 - https://code.visualstudio.com/

   - 확장 프로그램 설치
      - https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl

## 1. WSL ( Windows Subsystem for Linux ) 설치

- 시작 메뉴에서 `PowerShell`을 검색하고, **"관리자 권한으로 실행"** 을 선택합니다.

- WSL 설치 명령으로 WSL을 실행하는 데 필요한 모든 항목을 설치할 수 있습니다
   ```powershell
   > wsl --install
   ```

- PC 재시작
활성화 후 컴퓨터를 재시작합니다.

## 2. Ubuntu 24.04.1 LTS 배포판 설치
1. `PowerShell`에서 `WSL2`를 기본 버전으로 설정:
   ```powershell
   > wsl --set-default-version 2
   ```
2. **Microsoft Store에서 원하는 리눅스 배포판 설치** ( 선택 ) :
   - 윈도우 검색에서 **Microsoft Store**를 열고, 스토어에서 [ **Ubuntu 24.04.1 LTS** ] 을 검색하여 설치합니다.

3. **설치 후 리눅스 배포판 실행**:

   배포판을 설치한 후, 열기 버튼 또는 해당 배포판을 검색 후 실행합니다.    
   실행 시 첫 번째 설정이 진행되며, 사용자 이름과 비밀번호를 설정해야 합니다.

   실습시 용이하게 아래와 같이 ubuntu / ubuntu 로 아이디 패스워드를 설정합니다.

   ![아이디패스워드입력](https://private-user-images.githubusercontent.com/4231941/505783268-cf43696e-2a03-4358-a2f7-7a76f207e1d2.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjE1MjkyMDIsIm5iZiI6MTc2MTUyODkwMiwicGF0aCI6Ii80MjMxOTQxLzUwNTc4MzI2OC1jZjQzNjk2ZS0yYTAzLTQzNTgtYTJmNy03YTc2ZjIwN2UxZDIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MTAyNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTEwMjdUMDEzNTAyWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MDA2NDZiZjRjMGEwMGJhNzcxMTdkMmE1ZTU5YTkwZmE5ZTcyMDhiOGUxNWVmMDFiOWVjM2Y4ZGNhMzY4MTdlZCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.TVsQDdTu09fGYu3L2-_nNhOtl7atsciGfJX9HDIvJLU)

4. WSL 접속시 기본적으로 Windows의 드라이브(C:) 의 /mnt/c 경로로 가는걸 방지하기 위해 아래 명령어들을 입력해주세요.   
- ~/.bashrc 파일 수정
   ```bash
   $ echo 'cd ~' >> ~/.bashrc
   ```
- wsl 접속종료
   ```bash
   $ exit
   ```
- wsl 재연결
   ```
   > wsl
   ```
   
5. `PowerShell`에서 아래 명령어로 WSL2가 제대로 설치 되었는지 배포판 목록들을 확인할 수 있습니다.   
   ```powershell
   > wsl --list --verbose
   ```
   ![배포판설치목록](https://private-user-images.githubusercontent.com/4231941/505783269-80d575d8-1c8f-4f14-ab10-c47fe85899ea.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjE1MjkzNjcsIm5iZiI6MTc2MTUyOTA2NywicGF0aCI6Ii80MjMxOTQxLzUwNTc4MzI2OS04MGQ1NzVkOC0xYzhmLTRmMTQtYWIxMC1jNDdmZTg1ODk5ZWEucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MTAyNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTEwMjdUMDEzNzQ3WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NThmNjg1MmZmNmQ2OTdjOTFkNTgxYzUyMzQ3ZDgzZmRhOWVmMGE0NWJlMTk0MTEyYjVhM2VmYjgzYmY2ZGZmZiZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.p3zsTiI21zWK5OIuNp-Ugd28C5rbWO8X8qeZgh4hH-A)

   - 배포판이 여러개 존재할 경우
      - 아래 명령어로 실행하기 원하는 배포판을 선택합니다.

         ```powershell
         > wsl --set-default Ubuntu-24.04
         ```

   - 비밀번호 분실시 아래와 같이 root 권한으로 접속
      ``` 
      > wsl -u root
      ```

      - 아래 명령어를 입력 후 비밀번호 재설정
         ```bash
         $ passwd 사용자계정
         ```


## 3. 웹서버(nginx) 설치

1. `PowerShell` 에서 `wsl` 명령어로 사용자의 홈 디렉터리로 접속   
( 여기서부턴 관리자권한 없이 PowerShell 을 사용하는걸 권장합니다. )
   ```powershell
   > wsl ~
   ```


2. Nginx 설치
   - ubuntu에서 `apt` 명령어는 리눅스 패키지 도구로써 웹서버,디비서버 등 다양한 패키지들을 쉽게 설치 하도록 도와준다.
   - 공식설치가이드 https://nginx.org/en/linux_packages.html#Ubuntu 
   - 아래 명령어를 순서대로 입력한다.
      - 설치 가능한 패키지 리스트를 최신화
         ```bash
         $ sudo apt update
         ```

      - 필수 구성요소 설치
         ```bash
         $ sudo apt install -y curl gnupg2 ca-certificates lsb-release ubuntu-keyring bind9-dnsutils
         ```

      - 공식 nginx 서명 키를 가져와 패키지의 진위 여부를 확인할 수 있습니다.
         ```bash
         $ curl https://nginx.org/keys/nginx_signing.key | gpg --dearmor | sudo tee /usr/share/keyrings/nginx-archive-keyring.gpg >/dev/null
         ```
      - 다운로드한 파일에 올바른 키가 포함되어 있는지 확인합니다
         ```bash
         $ gpg --dry-run --quiet --no-keyring --import --import-options import-show /usr/share/keyrings/nginx-archive-keyring.gpg
         ```    
      - 출력 결과가 아래와 같은 내용이 포함되어 있으면 정상입니다.

         `
         pub   rsa2048 2011-08-19 [SC] [expires: 2027-05-24]
         573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62
         uid                      nginx signing key <signing-key@nginx.com>
         `

      - 안정적인 nginx 패키지를 위한 apt 저장소를 설정하려면 다음 명령을 실행합니다
         ```bash
         $ echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] http://nginx.org/packages/ubuntu `lsb_release -cs` nginx" | sudo tee /etc/apt/sources.list.d/nginx.list
         ```

      - 배포판에서 제공하는 패키지보다 당사 패키지를 선호하도록 저장소 고정을 설정합니다.
         ```bash
         $ echo -e "Package: *\nPin: origin nginx.org\nPin: release o=nginx\nPin-Priority: 900\n" | sudo tee /etc/apt/preferences.d/99nginx
         ```

      - 패키지리스트를 수정했으니 다시 설치 가능한 패키지 리스트를 최신화
         ```bash
         $ sudo apt update         
         ```
      - nginx 설치
         ```bash
         $ sudo apt install nginx
         ```

      - nginx 설치확인
         ```bash
         $ nginx -v
         ```
         `nginx version: nginx/1.28.0`  
      - nginx 서버 실행
         ```bash
         $ sudo service nginx start
         ```

   - 웹서버(nginx)가 정상적으로 실행중인지 브라우저를 열어서 확인하기

       - 주소 : http://localhost/
      ![브라우저](https://private-user-images.githubusercontent.com/4231941/505673943-203b467e-2bae-4b01-9daf-50509ec793c3.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjE1MjY4MTksIm5iZiI6MTc2MTUyNjUxOSwicGF0aCI6Ii80MjMxOTQxLzUwNTY3Mzk0My0yMDNiNDY3ZS0yYmFlLTRiMDEtOWRhZi01MDUwOWVjNzkzYzMucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MTAyNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTEwMjdUMDA1NTE5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9OGUwMmM2YjhiZGNmNzk3ZWRiNTY2MWIwZDYxNDEwMmM4Mzc2NmMzYTViOTgwNWIxOTFiNzRhMjE2MWMxM2VjOCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.mG0r-Vr7DHwHrY8MUDuEiwMasXzilLmxlw3--tLREDA)

## 4. PHP ( PHP-FPM ) 설치
- PHP-FPM ( PHP FastCGI Process Manager ) 은 웹 서버와 연동해서 PHP 스크립트를 실행할 수 있게 해주는 프로세스 관리자입니다. 

- Nginx와 연동하여 성능 최적화와 비동기 처리를 제공하는 PHP의 FastCGI 버전입니다. 고성능 웹 애플리케이션에서 주로 사용됩니다.

   ### 1. PHP-FPM 설치
   - PHP-FPM 설치를 하려면 아래 명령어를 입력하세요.
      ```bash
      $ sudo apt install -y php8.3-fpm
      ```
   - 설치가 완료되었는지 버전확인
      ```bash
      $ php -v
      ```

   - php timezone 설정
      ```bash
      $ sudo sed -i 's~^;*date\.timezone *=.*~date.timezone = "Asia/Seoul"~' /etc/php/*/cli/php.ini
      ```

   - PHP-FPM 서비스 시작
      ```bash
      $ sudo service php8.3-fpm start
      ```
   - PHP-FPM 서비스 상태확인
      ```bash
      $ sudo service php8.3-fpm status
      ```

   ### 2. Composer 설치
   - Composer는 PHP의 의존성 관리 도구로, PHP 프로젝트에서 필요한 라이브러리나 패키지를 손쉽게 관리하고 설치할 수 있게 도와줍니다. Composer는 프로젝트에 필요한 외부 라이브러리의 버전을 명시하고, 이를 자동으로 다운로드하고 설치하는 기능을 제공합니다. 

      1.  Composer를 설치 이전에 curl과 unzip을 설치합니다.
            ```bash
            $ sudo apt install -y curl unzip
            ```

      2. Composer를 다운로드하고 글로벌로 설치하려면 다음 명령어를 실행합니다.

         ```bash
         $ curl -sS https://getcomposer.org/installer | php         
         ```
         ```bash
         $ sudo mv composer.phar /usr/local/bin/composer
         ```

      3. Composer가 정상적으로 설치되었는지 확인하려면 아래 명령어를 실행합니다.

         ```bash
         $ composer --version
         ```

## 5. Nginx 설정 및 PHP 동작 환경 설정하기

   1. 현재 nginx에서 `localhost`주소로 설정된 파일을 보려면 nginx 설정을 아래 명령어를 입력합니다.
      ```bash
      $ code /etc/nginx/conf.d/default.conf
      ```

      
   2. `default.conf`는 nginx의 `localhost`에 대한 기본 서버 설정 파일입니다.
         ```nginx
         server { # 특정 서버나 호스트에 대한 요청을 처리하는 설정 블록
            listen       80; # 80번 포트에서 요청을 받겠다는 의미
            server_name  localhost; # 도메인 또는 ip 여러개 가능

            #access_log  /var/log/nginx/host.access.log  main; # 요청(request) 에 대해 로그 기록할 파일

            location / { # 특정 URI(Uniform Resource Identifier)에 대해 어떻게 요청을 처리할지를 정의하는 블록
               root   /usr/share/nginx/html; # /usr/share/nginx/html 폴더에서 파일을 찾습니다.
               index  index.html index.htm; # 디렉토리 요청 시 반환할 기본 파일을 설정합니다. 보통 index.html 을 사용합니다.
            }
            
            error_page   500 502 503 504  /50x.html; # 500,502,503,504 에러코드일때 /50x.html 요청
            location = /50x.html { # /50x.html 파일 요청시
               root   /usr/share/nginx/html; # /usr/share/nginx/html 폴더에서 파일을 찾습니다.
            }
         }
         ```

   3. nginx에서 사용하는 `/usr/share/nginx/html` 디렉토리가 아닌 작업할 디렉토리를 새롭게 만들어 보겠습니다.
      ```bash
      $ sudo mkdir /var/www # www 폴더 생성

      $ sudo chown ubuntu:ubuntu /var/www  # 사용자 권한 설정

      $ mkdir /var/www/localhost # www 폴더 아래 localhost 디렉토리 생성      
      
      $ cp /usr/share/nginx/html/* /var/www/localhost/ # nginx 기본 html 파일들 복사
      ```

   4. http://localhost 로 요청시 새롭게 만든 디렉토리로 경로를 참조하려면 아래의 단계를 따릅니다.
      1. 기본 설정을 쓰지 않도록 파일이름 변경
         ```bash
         $ sudo mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.backup
         ```
      2. 새로운 설정파일 생성 후 권한 변경 후 편집
         
         ```bash
         $ sudo touch /etc/nginx/conf.d/localhost.conf # 설정파일 생성   

         $ sudo chown $USER:$USER /etc/nginx/conf.d/localhost.conf # 현재 로그인한 사용자로 권한 변경

         $ code /etc/nginx/conf.d/localhost.conf # 설정파일 vscode 로 열기
         ```

         `VSCode` 에서 내용을 아래와 같이 입력합니다.
         ```nginx
          server { # 특정 서버나 호스트에 대한 요청을 처리하는 설정 블록
            listen       80; # 80번 포트에서 요청을 받겠다는 의미
            server_name  localhost; # 도메인 또는 ip 여러개 가능
            root   /var/www/localhost; # /var/www/localhost 폴더에서 파일을 찾습니다

            # 특정 URI(Uniform Resource Identifier)에 대해 어떻게 요청을 처리할지를 정의하는 블록.
            location / {                
               # 디렉토리 요청 시 반환할 기본 파일을 설정합니다. 보통 index.html 을 사용합니다.
               index  index.html index.htm; 
            }

            # 500,502,503,504 에러코드일때 /var/www/localhost/50x.html 파일을 보여줍니다.
            error_page   500 502 503 504  /50x.html; 

            # 경로 상관없이 파일 확장자가 php 로 요청이 올때 ( 정규표현식 사용 )
            location ~ \.(php)$ { 

               # 요청이 처리될 php-fpm 프로세스 위치 ( nginx와 php-fpm 통신할때 핵심 설정 )
               fastcgi_pass unix:/run/php/php8.3-fpm.sock; 
               
               # /etc/nginx/fastcgi_params 경로에 있는 환경 변수 세트를 불러온다.
               include fastcgi_params; 
               
               # PHP-FPM 이 처리할 파일의 경로 지정. 
               fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

            }
         }

         ```

         - Nginx와 PHP-FPM이 통신할 때 `fastcgi_param` 이라는 “환경 변수”를 통해 정보를 주고받습니다.

      3. php-fpm 권한 문제를 해결하기 위해 nginx user 변경
         ```bash
         $ sudo sed -i 's/^\s*user\s\+\S\+;/user www-data;/' /etc/nginx/nginx.conf
         ```

      4. 설정된 내용을 다시 불러오기 위해 재시작
         ```
         $ sudo nginx -t # 설정파일 오류 검사
         $ sudo service nginx restart # nginx 재시작
         ```

   5. ~/www/localhost/index.html 열어서 내용을 수정합니다.
      ```
      $ code /usr/share/nginx/www/localhost/index.html
      ```

      아래의 내용 입력합니다.
      ``` html
      <!DOCTYPE html> <!-- 브라우저가 최신 웹 표준에 맞춰 작동하도록 사용함 -->
      <html>
      <head> <!-- HTML 문서의 정보를 담는 부분으로, 웹 페이지 자체에 표시되지는 않습니다. -->
         <title>Web Page</title> <!-- 페이지 제목 --> 
         
         <!-- css 태그 -->
         <style> 
            html { color-scheme: light dark; }
            body { width: 35em; margin: 0 auto;
            font-family: Tahoma, Verdana, Arial, sans-serif; }
         </style>

      </head>
      <body>
         <h1>Hello, World!</h1>
         <p><button id="myButton">click</button></p>
         
         <!-- javascript 태그 -->
         <script> 
            document.getElementById("myButton").addEventListener("click", function() {
                  alert("Button clicked!");
            });
         </script>

      </body>
      </html>
      ```

   7. http://localhost 를 열어서 바뀐 내용을 확인합니다.
   ![localhost화면](https://private-user-images.githubusercontent.com/4231941/505707864-49d56bd3-a505-44e5-96b5-68bd4fde0369.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjE1MjY4NzAsIm5iZiI6MTc2MTUyNjU3MCwicGF0aCI6Ii80MjMxOTQxLzUwNTcwNzg2NC00OWQ1NmJkMy1hNTA1LTQ0ZTUtOTZiNS02OGJkNGZkZTAzNjkucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MTAyNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTEwMjdUMDA1NjEwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9OTdiYzk3MGMyZDg3M2QyYTRlZDQzMTQ0N2UzYWY0MTg0M2ZkZWViMDBkNDljNTllYjQ1MDEyNDA2YTg3NzE1NCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.rgwlv-lmC9wTJTNeaaa50xqKY09aJkLoMuPEsBuAUXo)


## 6. wsl ubuntu nginx서버로 외부에서 접속할수 있도록 윈도우에서 설정
- 외부에서 접속 가능하도록 `Powershell`에서 ip 확인
   ```Powershell
   wsl hostname -I
   ```
   `172.27.96.182`

- 윈도우에서 PowerShell을 관리자 권한으로 실행하여 netsh 명령어를 사용해 포트포워딩을 설정합니다.

   ```Powershell
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=172.27.96.182
   ```

   ```Powershell
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 protocol=tcp connectport=80 connectaddress=172.27.96.182
   ```

- 포트포워딩 내역 조회 
   ```Powershell
   netsh interface portproxy show all
   ```

- 윈도우 방화벽 설정 ( 외부에서 80번 포트로 접근할 수 있도록 허용 )
   1. "Windows Defender 방화벽"을 검색하여 실행합니다. 
   2. "고급 설정"으로 이동합니다."인바운드 규칙"에서 새 규칙을 추가하거나, 기존 규칙을 수정합니다. 
   3. 프로토콜: TCP, 로컬 포트: 80, 작업: "연결 허용"으로 설정합니다. 
   ![방화벽포트허용](https://private-user-images.githubusercontent.com/4231941/505676790-bfbee2d4-046f-4d2d-a865-cdfde7c60185.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjE1MjY4NjcsIm5iZiI6MTc2MTUyNjU2NywicGF0aCI6Ii80MjMxOTQxLzUwNTY3Njc5MC1iZmJlZTJkNC0wNDZmLTRkMmQtYTg2NS1jZGZkZTdjNjAxODUucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MTAyNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTEwMjdUMDA1NjA3WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MmE5MzU3ZmYxZGM2NmRjZTg5MWRlZjkwMjgxZTUzMTBiYjlkYTVkNjEyMWQ0NDgyNjNlMWE0YzcwZjcwYTc3YyZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.ong3QlDtIR6x5mfNF2KKDelFAUF3u_uvNFMBlPXhcrg)
